{% extends "base.html" %}

{% block title %}{{ _('Inventory Analytics') }} - Dialfa BI{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-boxes"></i>
            {{ _('Inventory Analytics') }}
        </h1>
        <p class="text-muted">Inventory optimization, stock analysis, and supply chain insights</p>
    </div>
</div>

<!-- Key Inventory Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card border-primary">
            <div class="card-body text-center">
                <i class="bi bi-box-seam text-primary mb-2" style="font-size: 2rem;"></i>
                <h3 id="total-products" class="text-primary">Loading...</h3>
                <p class="card-text">Total Products</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card border-success">
            <div class="card-body text-center">
                <i class="bi bi-currency-dollar text-success mb-2" style="font-size: 2rem;"></i>
                <h3 id="total-value" class="text-success">Loading...</h3>
                <p class="card-text">Total Value</p>
                <hr class="my-2">
                <div style="font-size: 0.75rem;">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Healthy:</span>
                        <strong id="healthy-stock-value" class="text-success">-</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Dead:</span>
                        <strong id="dead-stock-value-card" class="text-danger">-</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card border-warning">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle text-warning mb-2" style="font-size: 2rem;"></i>
                <h3 id="slow-moving" class="text-warning">Loading...</h3>
                <p class="card-text">Slow Moving</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card border-danger">
            <div class="card-body text-center">
                <i class="bi bi-x-circle text-danger mb-2" style="font-size: 2rem;"></i>
                <h3 id="dead-stock" class="text-danger">Loading...</h3>
                <p class="card-text">Dead Stock</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart"></i>
                    Inventory by Category
                </h5>
            </div>
            <div class="card-body">
                <div id="category-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer2"></i>
                    Stock Health
                </h5>
            </div>
            <div class="card-body">
                <div id="stock-health-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- Stock Value Evolution Chart -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i>
                    {{ _('Stock Value Evolution') }}
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="loadStockValueData(6)">6M</button>
                    <button type="button" class="btn btn-outline-primary active" onclick="loadStockValueData(12)">12M</button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadStockValueData(24)">24M</button>
                </div>
            </div>
            <div class="card-body">
                <div id="stock-value-evolution-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar3"></i>
                    {{ _('Monthly Breakdown') }}
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>{{ _('Month') }}</th>
                                <th class="text-end">{{ _('Value') }}</th>
                                <th class="text-end">{{ _('Change') }}</th>
                            </tr>
                        </thead>
                        <tbody id="stock-value-breakdown-table">
                            <tr>
                                <td colspan="3" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stock Alert Summaries -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Out of Stock</h6>
                    <i class="bi bi-exclamation-circle text-danger fs-4"></i>
                </div>
                <h3 class="text-danger mb-1" id="out-of-stock-summary-count">0</h3>
                <p class="text-muted small mb-0">Products unavailable</p>
                <p class="text-danger small mb-0" id="out-of-stock-lost-sales">Est. Lost Sales: ARS 0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Low Stock</h6>
                    <i class="bi bi-exclamation-triangle text-warning fs-4"></i>
                </div>
                <h3 class="text-warning mb-1" id="low-stock-summary-count">0</h3>
                <p class="text-muted small mb-0">Products need reorder</p>
                <p class="text-warning small mb-0" id="low-stock-value">Value at Risk: ARS 0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Overstock</h6>
                    <i class="bi bi-arrow-up-circle text-info fs-4"></i>
                </div>
                <h3 class="text-info mb-1" id="overstock-summary-count">0</h3>
                <p class="text-muted small mb-0">Excess inventory</p>
                <p class="text-info small mb-0" id="overstock-value">Tied Capital: ARS 0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-secondary">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Dead Stock</h6>
                    <i class="bi bi-arrow-down-circle text-secondary fs-4"></i>
                </div>
                <h3 class="text-secondary mb-1" id="dead-stock-summary-count">0</h3>
                <p class="text-muted small mb-0">No sales 365+ days</p>
                <p class="text-secondary small mb-0" id="dead-stock-value">Trapped Value: $0</p>
            </div>
        </div>
    </div>
</div>

<!-- Stock Alerts Details -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-2">
                    <i class="bi bi-exclamation-circle text-danger"></i>
                    Out of Stock Analysis
                </h5>
                <div class="row g-2 small">
                    <div class="col-6">
                        <span class="badge bg-danger" id="oos-healthy-badge">0</span> <span class="text-muted">Healthy (Urgent)</span>
                    </div>
                    <div class="col-6">
                        <span class="badge bg-warning text-dark" id="oos-slow-badge">0</span> <span class="text-muted">Slow/Moderate</span>
                    </div>
                    <div class="col-6">
                        <span class="badge bg-secondary" id="oos-dead-badge">0</span> <span class="text-muted">Dead Stock</span>
                    </div>
                    <div class="col-6">
                        <span class="badge bg-dark" id="oos-discontinued-badge">0</span> <span class="text-muted">Discontinued</span>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 350px;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Product</th>
                                <th>Profile</th>
                                <th>Last Sale</th>
                                <th class="text-end">Lost Sales</th>
                            </tr>
                        </thead>
                        <tbody id="out-of-stock-tbody">
                            <tr>
                                <td colspan="4" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-exclamation-triangle text-warning"></i>
                    Low Stock Details
                </h5>
                <span class="badge bg-warning" id="low-stock-count">0</span>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 350px;">
                    <table class="table table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="low-stock-tbody">
                            <tr>
                                <td colspan="4" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                        <tfoot id="low-stock-summary" class="table-warning" style="display: none;">
                            <tr>
                                <th><strong>TOTAL</strong></th>
                                <th><span class="badge bg-warning" id="low-stock-categories-summary">0</span> Categories</th>
                                <th><span id="low-stock-total-units">0</span> units</th>
                                <th><span class="text-warning" id="low-stock-reorder-cost">Reorder: $0</span></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-arrow-up-circle text-info"></i>
                    Overstock Details
                </h5>
                <span class="badge bg-info" id="overstock-count">0</span>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 350px;">
                    <table class="table table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="overstock-tbody">
                            <tr>
                                <td colspan="4" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                        <tfoot id="overstock-summary" class="table-info" style="display: none;">
                            <tr>
                                <th><strong>TOTAL</strong></th>
                                <th><span class="badge bg-info" id="overstock-categories-summary">0</span> Categories</th>
                                <th><span id="overstock-total-units">0</span> excess</th>
                                <th><span class="text-info" id="overstock-tied-capital">Capital: $0</span></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Financial Impact Summary -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calculator"></i>
                    Financial Impact Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-danger mb-1" id="total-dead-stock-value">$0</h4>
                            <p class="mb-0 small text-muted">
                                Dead Stock Value
                                <i class="bi bi-question-circle text-muted ms-1" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="Valor total del inventario sin movimiento por más de 365 días. Este capital está 'muerto' y genera solo costos sin retorno. Acción urgente: liquidar mediante descuentos o promociones."
                                   style="cursor: help;"></i>
                            </p>
                            <p class="mb-0 small text-danger" id="dead-stock-carrying-cost">Monthly Cost: $0</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-warning mb-1" id="total-low-stock-impact">$0</h4>
                            <p class="mb-0 small text-muted">
                                Low Stock Risk
                                <i class="bi bi-question-circle text-muted ms-1" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="Riesgo de pérdida de ventas por productos con stock bajo. Incluye productos con menos de 1 mes de inventario según la demanda histórica. Acción: reabastecer urgentemente."
                                   style="cursor: help;"></i>
                            </p>
                            <p class="mb-0 small text-warning" id="potential-stockout-cost">Potential Lost Sales</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-info mb-1" id="total-overstock-value">$0</h4>
                            <p class="mb-0 small text-muted">
                                Overstock Value
                                <i class="bi bi-question-circle text-muted ms-1" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="Valor del inventario excesivo (más de 6 meses de suministro). Capital inmovilizado que genera costos de almacenamiento. Acción: reducir pedidos futuros y considerar promociones."
                                   style="cursor: help;"></i>
                            </p>
                            <p class="mb-0 small text-info" id="overstock-carrying-cost">Excess Carrying Cost</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-success mb-1" id="optimization-potential">$0</h4>
                            <p class="mb-0 small text-muted">Optimization Potential</p>
                            <p class="mb-0 small text-success">Annual Savings</p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Key Insights:</h6>
                        <ul class="list-unstyled small" id="financial-insights">
                            <li><i class="bi bi-info-circle text-info"></i> Loading insights...</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Recommended Actions:</h6>
                        <ul class="list-unstyled small" id="financial-recommendations">
                            <li><i class="bi bi-lightbulb text-warning"></i> Loading recommendations...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Optimization -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-arrow-down-circle text-danger"></i>
                    Dead Stock Analysis
                </h5>
                <span class="badge bg-danger" id="dead-stock-count">0</span>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Stock Value</th>
                                <th>Days Since Sale</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="dead-stock-tbody">
                            <tr>
                                <td colspan="5" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                        <tfoot id="dead-stock-summary" class="table-dark" style="display: none;">
                            <tr>
                                <th><strong>TOTAL (Top 10 shown)</strong></th>
                                <th><span class="badge bg-info" id="dead-stock-categories-count">0</span> Categories</th>
                                <th class="text-warning"><strong id="dead-stock-total-value">$0</strong></th>
                                <th><span id="dead-stock-avg-days">0</span> avg days</th>
                                <th><span class="badge bg-danger" id="dead-stock-total-items">0</span> items</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-arrow-up-circle text-success"></i>
                    Top Stock by Value
                </h5>
                <span class="badge bg-success" id="top-stock-count">0</span>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Current Stock</th>
                                <th>Stock Value</th>
                                <th>Unit Price</th>
                            </tr>
                        </thead>
                        <tbody id="top-stock-tbody">
                            <tr>
                                <td colspan="5" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                        <tfoot id="top-stock-summary" class="table-success" style="display: none;">
                            <tr>
                                <th><strong>TOTAL (Top 10 shown)</strong></th>
                                <th><span class="badge bg-success" id="top-stock-categories-count">0</span> Categories</th>
                                <th><span id="top-stock-total-quantity">0</span> units</th>
                                <th class="text-success"><strong id="top-stock-total-value">$0</strong></th>
                                <th><span id="top-stock-avg-price">$0</span> avg</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Insights -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i>
                    {{ _('Stock Turnover Rate') }}
                    <i class="bi bi-question-circle text-light ms-2" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="top" 
                       title="{{ _('Stock Turnover Rate Tooltip') }}"
                       style="cursor: help;"></i>
                </h5>
            </div>
            <div class="card-body text-center">
                <h2 id="turnover-rate" class="text-primary">{{ _('Loading...') }}</h2>
                <p class="text-muted">{{ _('Times per year') }}</p>
                <div class="progress">
                    <div id="turnover-progress" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted">Target: 6x per year</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calculator"></i>
                    {{ _('Carrying Cost') }}
                    <i class="bi bi-question-circle text-light ms-2" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="top" 
                       title="{{ _('Carrying Cost Tooltip') }}"
                       style="cursor: help;"></i>
                </h5>
            </div>
            <div class="card-body text-center">
                <h2 id="carrying-cost" class="text-warning">{{ _('Loading...') }}</h2>
                <p class="text-muted">{{ _('Monthly cost') }}</p>
                <div class="progress">
                    <div id="carrying-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted">2% of inventory value</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-exclamation-diamond"></i>
                    {{ _('Optimization Potential') }}
                    <i class="bi bi-question-circle text-light ms-2" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="top" 
                       title="{{ _('Optimization Potential Tooltip') }}"
                       style="cursor: help;"></i>
                </h5>
            </div>
            <div class="card-body text-center">
                <h2 id="optimization-potential-card" class="text-success">{{ _('Loading...') }}</h2>
                <p class="text-muted">{{ _('Potential savings') }}</p>
                <div class="progress">
                    <div id="optimization-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted">From dead stock reduction</small>
            </div>
        </div>
    </div>
</div>

<!-- Stock Variation Over Time Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up-arrow"></i>
                    Stock Variation & Velocity Analysis
                </h5>
            </div>
            <div class="card-body">
                <!-- Stock Velocity KPIs -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <i class="bi bi-speedometer2 text-primary mb-2" style="font-size: 2rem;"></i>
                                <h4 id="overall-turnover-rate" class="text-primary">Loading...</h4>
                                <p class="card-text">
                                    Overall Turnover Rate
                                    <i class="bi bi-question-circle text-muted ms-1" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top" 
                                       title="Indica cuántas veces al año se convierte el inventario en ventas. Un valor alto significa mejor eficiencia de capital. Meta: 6x por año. Cálculo: (Ventas Anuales ÷ Valor Promedio de Inventario) × 100"
                                       style="cursor: help;"></i>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="bi bi-arrow-up-circle text-success mb-2" style="font-size: 2rem;"></i>
                                <h4 id="high-velocity-products" class="text-success">Loading...</h4>
                                <p class="card-text">
                                    High Velocity Products
                                    <i class="bi bi-question-circle text-muted ms-1" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top" 
                                       title="Productos que rotan 4+ veces por año. Son los más rentables y eficientes en términos de capital. Requieren reabastecimiento frecuente pero generan flujo de caja constante."
                                       style="cursor: help;"></i>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <i class="bi bi-arrow-down-circle text-warning mb-2" style="font-size: 2rem;"></i>
                                <h4 id="low-velocity-products" class="text-warning">Loading...</h4>
                                <p class="card-text">
                                    Low Velocity Products
                                    <i class="bi bi-question-circle text-muted ms-1" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top" 
                                       title="Productos que rotan menos de 2 veces por año. Consumen capital y espacio de almacén. Considerar descuentos, promociones o descontinuar según demanda."
                                       style="cursor: help;"></i>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <i class="bi bi-pause-circle text-danger mb-2" style="font-size: 2rem;"></i>
                                <h4 id="no-movement-products" class="text-danger">Loading...</h4>
                                <p class="card-text">
                                    No Movement
                                    <i class="bi bi-question-circle text-muted ms-1" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top" 
                                       title="Productos sin ventas en los últimos 12 meses. Inventario muerto que genera costos de almacenamiento sin retorno. Acción urgente: liquidar o descartar."
                                       style="cursor: help;"></i>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-bar-chart"></i>
                                    Monthly Stock Movement Trends
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="stock-movement-chart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-pie-chart"></i>
                                    Velocity Distribution
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="velocity-distribution-chart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Velocity Summary Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-table"></i>
                                    Top Products by Velocity & Turnover
                                </h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary active" data-filter="all">All</button>
                                    <button type="button" class="btn btn-outline-success" data-filter="high">High Velocity</button>
                                    <button type="button" class="btn btn-outline-warning" data-filter="low">Low Velocity</button>
                                    <button type="button" class="btn btn-outline-danger" data-filter="dead">Dead Stock</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 400px;">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-dark sticky-top">
                                            <tr>
                                                <th>Product</th>
                                                <th>Category</th>
                                                <th>Current Stock</th>
                                                <th>Annual Sales</th>
                                                <th>Turnover %</th>
                                                <th>Trend</th>
                                                <th>Months of Stock</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="velocity-summary-tbody">
                                            <tr>
                                                <td colspan="8" class="text-center">Loading...</td>
                                            </tr>
                                        </tbody>
                                        <tfoot id="velocity-summary-footer" class="table-secondary" style="display: none;">
                                            <tr>
                                                <th><strong>SUMMARY</strong></th>
                                                <th><span class="badge bg-secondary" id="velocity-categories-count">0</span> Categories</th>
                                                <th><span id="velocity-total-stock">0</span> units</th>
                                                <th><span id="velocity-total-sales">$0</span></th>
                                                <th><span id="velocity-avg-turnover">0%</span></th>
                                                <th><span class="badge bg-info" id="velocity-positive-trends">0</span> ↗</th>
                                                <th><span id="velocity-avg-months">0</span> months</th>
                                                <th><span class="badge bg-success" id="velocity-healthy-count">0</span> Healthy</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Items -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-check"></i>
                    Recommended Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-exclamation-triangle"></i> Urgent Actions</h6>
                            <ul id="urgent-actions" class="mb-0">
                                <li>Loading...</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-warning">
                            <h6><i class="bi bi-clock"></i> Medium Priority</h6>
                            <ul id="medium-actions" class="mb-0">
                                <li>Loading...</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-lightbulb"></i> Optimization Ideas</h6>
                            <ul id="optimization-actions" class="mb-0">
                                <li>Loading...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Utility function to format currency
function formatCurrency(amount, currency = 'USD') {
    if (amount >= 1000000) {
        return `${currency} ${(amount/1000000).toFixed(1)}M`;
    } else if (amount >= 1000) {
        return `${currency} ${(amount/1000).toFixed(1)}K`;
    } else {
        return `${currency} ${amount.toFixed(2)}`;
    }
}

// Load inventory data when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    loadInventoryData();
    loadCategoryChart();
    loadStockHealthChart();
    loadStockValueData(12);
    loadStockAlerts();
    loadDeadStockAnalysis();
    loadTopStockAnalysis();
    loadInventoryInsights();
    loadRecommendedActions();
    loadStockVariationAnalysis();
});

function loadInventoryData() {
    // Load basic summary
    fetch('/inventory/api/summary')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const summary = data.data;
                document.getElementById('total-products').textContent = summary.total_products.toLocaleString();
                document.getElementById('total-value').textContent = summary.formatted.total_value;
                
                const totalValue = summary.total_value;
                
                // Now get dead stock to calculate healthy stock correctly
                fetch('/inventory/api/slow-moving')
                    .then(response => response.json())
                    .then(slowData => {
                        if (slowData.status === 'success') {
                            const slowMoving = slowData.data || [];
                            
                            // Calculate dead stock value (Dead Stock category)
                            const deadStockItems = slowMoving.filter(item => item.StockCategory === 'Dead Stock');
                            const deadStockValue = deadStockItems.reduce((sum, item) => sum + (item.StockValue || 0), 0);
                            
                            // Calculate slow moving count
                            const slowMovingCount = slowMoving.filter(item => 
                                item.StockCategory === 'Slow Moving' || item.StockCategory === 'Dead Stock'
                            ).length;
                            
                            // Healthy stock = Total - Dead Stock
                            const healthyStockValue = totalValue - deadStockValue;
                            
                            // Update cards
                            document.getElementById('healthy-stock-value').textContent = formatCurrency(healthyStockValue);
                            document.getElementById('dead-stock-value-card').textContent = formatCurrency(deadStockValue);
                            document.getElementById('slow-moving').textContent = slowMovingCount;
                            document.getElementById('dead-stock').textContent = deadStockItems.length;
                            
                            console.log(`Total: ${formatCurrency(totalValue)}, Dead: ${formatCurrency(deadStockValue)}, Healthy: ${formatCurrency(healthyStockValue)}`);
                        }
                    })
                    .catch(error => console.error('Error loading slow moving data:', error));
            }
        })
        .catch(error => console.error('Error loading inventory data:', error));
}

function loadCategoryChart() {
    // Load both category analysis and slow moving data to show dead stock breakdown
    Promise.all([
        fetch('/inventory/api/category-analysis').then(r => r.json()),
        fetch('/inventory/api/slow-moving').then(r => r.json())
    ])
    .then(([categoryData, slowData]) => {
        if (categoryData.status === 'success' && slowData.status === 'success') {
            createCategoryChartWithDeadStock(categoryData.data, slowData.data);
        }
    })
    .catch(error => console.error('Error loading category data:', error));
}

function createCategoryChartWithDeadStock(categories, slowMovingItems) {
    // Calculate dead stock value per category
    const deadStockByCategory = {};
    
    slowMovingItems
        .filter(item => item.StockCategory === 'Dead Stock')
        .forEach(item => {
            const category = item.Category || 'Unknown';
            deadStockByCategory[category] = (deadStockByCategory[category] || 0) + (item.StockValue || 0);
        });
    
    // Build sunburst data
    const labels = ['Total'];
    const parents = [''];
    const values = [categories.reduce((sum, c) => sum + c.TotalValue, 0)];
    const colors = ['#ffffff'];
    
    const categoryColors = {
        'Accesorios': '#033663',
        'Bridas': '#28a745',
        'Espárragos': '#ffc107',
        'Accesorio forjado': '#dc3545',
        'Nipples': '#17a2b8'
    };
    
    // Add categories
    categories.forEach(cat => {
        const categoryName = cat.Category;
        const totalValue = cat.TotalValue;
        const deadValue = deadStockByCategory[categoryName] || 0;
        const healthyValue = totalValue - deadValue;
        
        // Add category
        labels.push(categoryName);
        parents.push('Total');
        values.push(totalValue);
        colors.push(categoryColors[categoryName] || '#6f42c1');
        
        // Add healthy subcategory (only if > 0)
        if (healthyValue > 0) {
            labels.push(`${categoryName} - Healthy`);
            parents.push(categoryName);
            values.push(healthyValue);
            colors.push(categoryColors[categoryName] || '#6f42c1');
        }
        
        // Add dead stock subcategory (only if > 0)
        if (deadValue > 0) {
            labels.push(`${categoryName} - Dead Stock`);
            parents.push(categoryName);
            values.push(deadValue);
            colors.push('#dc3545'); // Red for dead stock
        }
    });
    
    const trace = {
        type: 'sunburst',
        labels: labels,
        parents: parents,
        values: values,
        branchvalues: 'total',
        marker: {
            colors: colors,
            line: { width: 2, color: '#ffffff' }
        },
        textinfo: 'label+percent parent',
        hovertemplate: '<b>%{label}</b><br>Value: $%{value:,.0f}<br>Percentage: %{percentParent}<extra></extra>'
    };
    
    const layout = {
        margin: { t: 10, r: 10, b: 10, l: 10 },
        sunburstcolorway: colors,
        extendsunburstcolors: true
    };
    
    Plotly.newPlot('category-chart', [trace], layout, {responsive: true});
    console.log('Category chart with dead stock breakdown created');
}

function loadStockHealthChart() {
    // Mock stock health data
    const healthData = [
        { status: 'Healthy', count: 800, color: '#28a745' },
        { status: 'Slow Moving', count: 270, color: '#ffc107' },
        { status: 'Dead Stock', count: 144, color: '#dc3545' },
        { status: 'Discontinued', count: 170, color: '#6c757d' }
    ];

    const trace = {
        labels: healthData.map(h => h.status),
        values: healthData.map(h => h.count),
        type: 'pie',
        marker: {
            colors: healthData.map(h => h.color)
        }
    };

    const layout = {
        margin: { t: 20, r: 20, b: 20, l: 20 },
        showlegend: true,
        legend: { orientation: 'v', x: 1.02, y: 0.5 }
    };

    Plotly.newPlot('stock-health-chart', [trace], layout, {responsive: true});
}

function loadStockAlerts() {
    // Load new out of stock analysis
    fetch('/inventory/api/out-of-stock-analysis')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                populateOutOfStockAnalysisTable(data.data, data.summary);
            }
        })
        .catch(error => console.error('Error loading out of stock analysis:', error));
    
    // Load regular stock alerts for low stock and overstock
    fetch('/inventory/api/stock-alerts')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const lowStock = data.data.filter(item => item.AlertType === 'LOW_STOCK');
                const overstock = data.data.filter(item => item.AlertType === 'OVERSTOCK');
                
                // Populate detail tables
                populateLowStockTable(lowStock);
                populateOverstockTable(overstock);
                
                // Update summary cards for low stock and overstock
                document.getElementById('low-stock-summary-count').textContent = lowStock.length;
                document.getElementById('overstock-summary-count').textContent = overstock.length;
                
                // Use real stock values from database
                const lowStockValue = lowStock.reduce((sum, item) => sum + (item.StockValue || 0), 0);
                const overstockValue = overstock.reduce((sum, item) => sum + (item.StockValue || 0), 0);
                
                document.getElementById('low-stock-value').textContent = 'Value at Risk: ' + formatUSD(lowStockValue);
                document.getElementById('overstock-value').textContent = 'Tied Capital: ' + formatUSD(overstockValue);
                document.getElementById('total-overstock-value').textContent = formatUSD(overstockValue);
                document.getElementById('overstock-carrying-cost').textContent = 'Excess Carrying Cost: ' + formatUSD(overstockValue * 0.02);
            }
        })
        .catch(error => console.error('Error loading stock alerts:', error));
}

function updateStockAlertSummaries(outOfStock, lowStock, overstock) {
    // Calculate values for each category using real stock values
    const lowStockValue = lowStock.reduce((sum, item) => sum + (item.StockValue || 0), 0);
    const overstockValue = overstock.reduce((sum, item) => sum + (item.StockValue || 0), 0);
    const outOfStockLostSales = outOfStock.length * 500; // Estimate $500 lost sales per item per month
    
    // Update summary cards
    document.getElementById('out-of-stock-summary-count').textContent = outOfStock.length;
    document.getElementById('low-stock-summary-count').textContent = lowStock.length;
    document.getElementById('overstock-summary-count').textContent = overstock.length;
    
    document.getElementById('out-of-stock-lost-sales').textContent = 'Est. Lost Sales: ' + formatUSD(outOfStockLostSales);
    document.getElementById('low-stock-value').textContent = 'Value at Risk: ' + formatUSD(lowStockValue);
    document.getElementById('overstock-value').textContent = 'Tied Capital: ' + formatUSD(overstockValue);
    
    // ALSO UPDATE Financial Impact Summary overstock value
    document.getElementById('total-overstock-value').textContent = formatUSD(overstockValue);
    document.getElementById('overstock-carrying-cost').textContent = 'Excess Carrying Cost: ' + formatUSD(overstockValue * 0.02); // 2% monthly carrying cost
}

function showStockAlertError(message) {
    document.getElementById('out-of-stock-tbody').innerHTML = '<tr><td colspan="3" class="text-center text-danger">' + message + '</td></tr>';
    document.getElementById('low-stock-tbody').innerHTML = '<tr><td colspan="4" class="text-center text-danger">' + message + '</td></tr>';
    document.getElementById('overstock-tbody').innerHTML = '<tr><td colspan="4" class="text-center text-danger">' + message + '</td></tr>';
}

function populateOutOfStockAnalysisTable(data, summary) {
    const tbody = document.getElementById('out-of-stock-tbody');
    
    // Update badges
    document.getElementById('oos-healthy-badge').textContent = summary.healthy_count;
    document.getElementById('oos-slow-badge').textContent = summary.slow_moving_count;
    document.getElementById('oos-dead-badge').textContent = summary.dead_stock_count;
    document.getElementById('oos-discontinued-badge').textContent = summary.discontinued_count;
    
    // Update summary card
    document.getElementById('out-of-stock-summary-count').textContent = summary.total_count;
    document.getElementById('out-of-stock-lost-sales').textContent = 'Est. Lost Sales: ' + formatUSD(summary.total_lost_sales);
    
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No out of stock items</td></tr>';
        return;
    }
    
    // Show top 20 items (sorted by priority and lost sales)
    const displayItems = data.slice(0, 20);
    displayItems.forEach(item => {
        const profileBadge = getProfileBadge(item.StockProfile);
        const daysAgo = item.DaysSinceLastSale > 1000 ? 'Never' : `${item.DaysSinceLastSale}d ago`;
        
        const row = document.createElement('tr');
        row.className = item.Priority === 4 ? 'table-danger' : '';
        row.innerHTML = `
            <td>
                <div><strong>${item.ProductName}</strong></div>
                <small class="text-muted">${item.Category}</small>
            </td>
            <td>${profileBadge}</td>
            <td class="small">${daysAgo}</td>
            <td class="text-end"><strong>${item.FormattedLostSales}</strong></td>
        `;
        tbody.appendChild(row);
    });
}

function getProfileBadge(profile) {
    const badges = {
        'Healthy': '<span class="badge bg-danger">Urgent</span>',
        'Moderate': '<span class="badge bg-warning text-dark">Moderate</span>',
        'Slow Moving': '<span class="badge bg-warning text-dark">Slow</span>',
        'Dead Stock': '<span class="badge bg-secondary">Dead</span>',
        'Discontinued': '<span class="badge bg-dark">Disc.</span>'
    };
    return badges[profile] || '<span class="badge bg-secondary">' + profile + '</span>';
}

function updateOutOfStockSummaryRow(allData) {
    const uniqueCategories = [...new Set(allData.map(item => item.Category))].length;
    const estimatedImpact = allData.length * 500; // $500 per item per month
    
    document.getElementById('out-of-stock-categories-summary').textContent = uniqueCategories;
    document.getElementById('out-of-stock-impact-summary').textContent = `Est. Impact: ${formatUSD(estimatedImpact)}/mo`;
}

function populateLowStockTable(data) {
    const tbody = document.getElementById('low-stock-tbody');
    const countBadge = document.getElementById('low-stock-count');
    const summaryRow = document.getElementById('low-stock-summary');
    
    tbody.innerHTML = '';
    countBadge.textContent = data.length;

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No low stock items</td></tr>';
        summaryRow.style.display = 'none';
        return;
    }

    // Show top 15 items
    const displayItems = data.slice(0, 15);
    displayItems.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${item.descripcion}</strong></td>
            <td><span class="badge bg-secondary">${item.Category}</span></td>
            <td><span class="badge bg-warning">${item.CurrentStock}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="reorderProduct('${item.descripcion}')">
                    <i class="bi bi-cart-plus"></i> Reorder
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Calculate and populate summary row
    updateLowStockSummaryRow(data);
    summaryRow.style.display = 'table-footer-group';
}

function updateLowStockSummaryRow(allData) {
    const uniqueCategories = [...new Set(allData.map(item => item.Category))].length;
    const totalUnits = allData.reduce((sum, item) => sum + item.CurrentStock, 0);
    const estimatedReorderCost = allData.length * 1000; // $1000 average reorder cost per item
    
    document.getElementById('low-stock-categories-summary').textContent = uniqueCategories;
    document.getElementById('low-stock-total-units').textContent = totalUnits;
    document.getElementById('low-stock-reorder-cost').textContent = `Reorder: ${formatUSD(estimatedReorderCost)}`;
}

function populateOverstockTable(data) {
    const tbody = document.getElementById('overstock-tbody');
    const countBadge = document.getElementById('overstock-count');
    const summaryRow = document.getElementById('overstock-summary');
    
    tbody.innerHTML = '';
    countBadge.textContent = data.length;

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No overstock items</td></tr>';
        summaryRow.style.display = 'none';
        return;
    }

    // Show top 15 items
    const displayItems = data.slice(0, 15);
    displayItems.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${item.descripcion}</strong></td>
            <td><span class="badge bg-secondary">${item.Category}</span></td>
            <td><span class="badge bg-info">${item.CurrentStock}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-warning" onclick="markForPromotion('${item.descripcion}')">
                    <i class="bi bi-percent"></i> Promote
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Calculate and populate summary row
    updateOverstockSummaryRow(data);
    summaryRow.style.display = 'table-footer-group';
}

function updateOverstockSummaryRow(allData) {
    const uniqueCategories = [...new Set(allData.map(item => item.Category))].length;
    const totalExcessUnits = allData.reduce((sum, item) => sum + (item.CurrentStock - 1000), 0); // Excess over 1000
    const estimatedTiedCapital = allData.reduce((sum, item) => sum + (item.CurrentStock * 25), 0); // $25 avg per unit
    
    document.getElementById('overstock-categories-summary').textContent = uniqueCategories;
    document.getElementById('overstock-total-units').textContent = totalExcessUnits.toLocaleString();
    document.getElementById('overstock-tied-capital').textContent = `Capital: ${formatUSD(estimatedTiedCapital)}`;
}

function loadDeadStockAnalysis() {
    fetch('/inventory/api/slow-moving')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const deadStockItems = data.data.filter(item => item.StockCategory === 'Dead Stock');
                
                // Update dead stock summary
                updateDeadStockSummary(deadStockItems);
                
                // Update financial impact summary
                updateFinancialImpactSummary(data.data);
                
                // Populate table
                populateDeadStockTable(deadStockItems);
            } else {
                console.error('API error:', data.error);
                document.getElementById('dead-stock-tbody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data: ' + (data.error || 'Unknown error') + '</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading dead stock:', error);
            document.getElementById('dead-stock-tbody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data: ' + error.message + '</td></tr>';
        });
}

function updateDeadStockSummary(deadStockItems) {
    const totalValue = deadStockItems.reduce((sum, item) => sum + item.StockValue, 0);
    const totalCarryingCost = deadStockItems.reduce((sum, item) => sum + item.MonthlyCarryingCost, 0);
    
    document.getElementById('dead-stock-summary-count').textContent = deadStockItems.length;
    document.getElementById('dead-stock-value').textContent = 'Trapped Value: ' + formatUSD(totalValue);
}

function updateFinancialImpactSummary(allItems) {
    const deadStock = allItems.filter(item => item.StockCategory === 'Dead Stock');
    const slowMoving = allItems.filter(item => item.StockCategory === 'Slow Moving');
    
    const deadStockValue = deadStock.reduce((sum, item) => sum + item.StockValue, 0);
    const deadStockCarryingCost = deadStock.reduce((sum, item) => sum + item.MonthlyCarryingCost, 0);
    const slowMovingValue = slowMoving.reduce((sum, item) => sum + item.StockValue, 0);
    
    // Calculate optimization potential (annual savings from dead stock + slow moving optimization)
    const optimizationPotential = (deadStockCarryingCost * 12) + (slowMovingValue * 0.1); // 10% of slow moving value
    
    // Update financial summary (SPISA data = USD)
    document.getElementById('total-dead-stock-value').textContent = formatUSD(deadStockValue);
    document.getElementById('dead-stock-carrying-cost').textContent = 'Monthly Cost: ' + formatUSD(deadStockCarryingCost);
    document.getElementById('optimization-potential').textContent = formatUSD(optimizationPotential);
    document.getElementById('optimization-potential-card').textContent = formatUSD(optimizationPotential);
    
    // Update insights and recommendations
    updateFinancialInsights(deadStock, slowMoving, deadStockValue, optimizationPotential);
}

function updateFinancialInsights(deadStock, slowMoving, deadStockValue, optimizationPotential) {
    const insights = [
        `${deadStock.length} products with $${(deadStockValue/1000000).toFixed(1)}M trapped in dead stock`,
        `${slowMoving.length} slow-moving items need attention`,
        `${(deadStockValue / (deadStockValue + slowMoving.reduce((sum, item) => sum + item.StockValue, 0)) * 100).toFixed(1)}% of problem inventory is dead stock`,
        `Average dead stock age: ${Math.round(deadStock.reduce((sum, item) => sum + item.DaysSinceLastSale, 0) / deadStock.length)} days`
    ];
    
    const recommendations = [
        'Liquidate dead stock through discounts or clearance sales',
        'Implement automated reorder points for fast-moving items',
        'Review supplier agreements for slow-moving categories',
        `Potential annual savings: ${formatCurrency(optimizationPotential)}`
    ];
    
    document.getElementById('financial-insights').innerHTML = insights.map(insight => 
        `<li><i class="bi bi-info-circle text-info"></i> ${insight}</li>`
    ).join('');
    
    document.getElementById('financial-recommendations').innerHTML = recommendations.map(rec => 
        `<li><i class="bi bi-lightbulb text-warning"></i> ${rec}</li>`
    ).join('');
}

function populateDeadStockTable(data) {
    const tbody = document.getElementById('dead-stock-tbody');
    const countBadge = document.getElementById('dead-stock-count');
    const summaryRow = document.getElementById('dead-stock-summary');
    
    if (!tbody) {
        console.error('Dead stock tbody element not found');
        return;
    }
    
    tbody.innerHTML = '';
    countBadge.textContent = data.length;

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No dead stock found</td></tr>';
        summaryRow.style.display = 'none';
        return;
    }

    // Show top 10 items
    const displayItems = data.slice(0, 10);
    displayItems.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${item.descripcion}</strong></td>
            <td><span class="badge bg-secondary">${item.Category}</span></td>
            <td class="text-danger">${formatCurrency(item.StockValue)}</td>
            <td>${item.DaysSinceLastSale}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="markForDiscount('${item.descripcion}')">
                    <i class="bi bi-percent"></i> Discount
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Calculate and populate summary row
    updateDeadStockSummaryRow(displayItems, data.length);
    summaryRow.style.display = 'table-footer-group';
}

function updateDeadStockSummaryRow(displayItems, totalItems) {
    const totalValue = displayItems.reduce((sum, item) => sum + item.StockValue, 0);
    const avgDays = Math.round(displayItems.reduce((sum, item) => sum + item.DaysSinceLastSale, 0) / displayItems.length);
    const uniqueCategories = [...new Set(displayItems.map(item => item.Category))].length;
    
    document.getElementById('dead-stock-total-value').textContent = formatUSD(totalValue);
    document.getElementById('dead-stock-avg-days').textContent = avgDays;
    document.getElementById('dead-stock-categories-count').textContent = uniqueCategories;
    document.getElementById('dead-stock-total-items').textContent = totalItems;
}

function loadTopStockAnalysis() {
    fetch('/inventory/api/top-stock-value')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                populateTopStockTable(data.data);
            }
        })
        .catch(error => console.error('Error loading top stock:', error));
}

function populateTopStockTable(data) {
    const tbody = document.getElementById('top-stock-tbody');
    const countBadge = document.getElementById('top-stock-count');
    const summaryRow = document.getElementById('top-stock-summary');
    
    tbody.innerHTML = '';
    countBadge.textContent = data.length;

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No top stock data available</td></tr>';
        summaryRow.style.display = 'none';
        return;
    }

    // Show top 10 items
    const displayItems = data.slice(0, 10);
    displayItems.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${item.descripcion}</strong></td>
            <td><span class="badge bg-primary">${item.Category}</span></td>
            <td>${item.CurrentStock.toLocaleString()}</td>
            <td class="text-success">${formatCurrency(item.StockValue)}</td>
            <td>${formatCurrency(item.UnitPrice)}</td>
        `;
        tbody.appendChild(row);
    });

    // Calculate and populate summary row
    updateTopStockSummaryRow(displayItems);
    summaryRow.style.display = 'table-footer-group';
}

function updateTopStockSummaryRow(displayItems) {
    const totalValue = displayItems.reduce((sum, item) => sum + item.StockValue, 0);
    const totalQuantity = displayItems.reduce((sum, item) => sum + item.CurrentStock, 0);
    const avgPrice = totalValue / totalQuantity;
    const uniqueCategories = [...new Set(displayItems.map(item => item.Category))].length;
    
    document.getElementById('top-stock-total-value').textContent = formatUSD(totalValue);
    document.getElementById('top-stock-total-quantity').textContent = totalQuantity.toLocaleString();
    document.getElementById('top-stock-avg-price').textContent = formatUSD(avgPrice);
    document.getElementById('top-stock-categories-count').textContent = uniqueCategories;
}

function loadInventoryInsights() {
    fetch('/inventory/api/summary')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const summary = data.data;
                
                // Stock turnover rate
                const turnoverRate = summary.stock_turnover_rate || 4.2;
                document.getElementById('turnover-rate').textContent = turnoverRate.toFixed(1) + 'x';
                document.getElementById('turnover-progress').style.width = Math.min((turnoverRate / 6) * 100, 100) + '%';
                
                // Carrying cost (2% of inventory value monthly)
                const carryingCost = summary.total_value * 0.02;
                document.getElementById('carrying-cost').textContent = formatCurrency(carryingCost);
                document.getElementById('carrying-progress').style.width = '100%';
                
                // Optimization potential (estimated from dead stock)
                const deadStockValue = summary.total_value * 0.12; // Assume 12% is dead stock
                document.getElementById('optimization-potential').textContent = formatCurrency(deadStockValue);
                document.getElementById('optimization-progress').style.width = '75%';
            }
        })
        .catch(error => console.error('Error loading inventory insights:', error));
}

function loadRecommendedActions() {
    // Mock recommended actions based on inventory analysis
    const urgentActions = [
        'Clear 144 dead stock items worth ARS $1.4M',
        'Review 27 products with no sales in 12+ months',
        'Investigate 15 high-value slow movers'
    ];
    
    const mediumActions = [
        'Optimize reorder points for top 50 products',
        'Review supplier contracts for slow movers',
        'Implement ABC analysis for better categorization'
    ];
    
    const optimizationActions = [
        'Set up automated reorder alerts',
        'Implement just-in-time for fast movers',
        'Create seasonal demand forecasting'
    ];
    
    document.getElementById('urgent-actions').innerHTML = urgentActions.map(action => `<li>${action}</li>`).join('');
    document.getElementById('medium-actions').innerHTML = mediumActions.map(action => `<li>${action}</li>`).join('');
    document.getElementById('optimization-actions').innerHTML = optimizationActions.map(action => `<li>${action}</li>`).join('');
}

function reorderProduct(productName) {
    alert(`Reordering ${productName} - Feature coming soon!`);
    // Implement reorder logic here
}

function markForPromotion(productName) {
    alert(`Marking ${productName} for promotion - Feature coming soon!`);
    // Implement promotion logic here
}

function markForDiscount(productName) {
    alert(`Marking ${productName} for discount - Feature coming soon!`);
}

// Stock Variation Analysis Functions
function loadStockVariationAnalysis() {
    loadStockVariationKPIs();
    loadStockMovementChart();
    loadVelocityDistributionChart();
    loadVelocitySummaryTable();
    setupVelocityTableFilters();
}

function loadStockVariationKPIs() {
    fetch('/inventory/api/stock-variation-kpis')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const kpis = data.data;
                
                // Update KPI cards
                document.getElementById('overall-turnover-rate').textContent = kpis.formatted.overall_turnover_percentage;
                document.getElementById('high-velocity-products').textContent = kpis.velocity_distribution.high_velocity;
                document.getElementById('low-velocity-products').textContent = kpis.velocity_distribution.low_velocity;
                document.getElementById('no-movement-products').textContent = kpis.velocity_distribution.no_movement;
                
                // Update optimization potential card with the actual KPI data
                if (document.getElementById('optimization-potential-card')) {
                    document.getElementById('optimization-potential-card').textContent = kpis.formatted.optimization_potential;
                    
                    // Update progress bar (assuming 10M is max potential)
                    const progressPercentage = (kpis.financial_impact.optimization_potential / 10000000) * 100;
                    document.getElementById('optimization-progress').style.width = Math.min(progressPercentage, 100) + '%';
                }
                
                console.log('Stock Variation KPIs loaded:', kpis);
            }
        })
        .catch(error => console.error('Error loading stock variation KPIs:', error));
}

function loadStockMovementChart() {
    fetch('/inventory/api/stock-variation-over-time')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                createStockMovementChart(data.data);
            }
        })
        .catch(error => console.error('Error loading stock movement data:', error));
}

function createStockMovementChart(data) {
    if (!data || data.length === 0) {
        document.getElementById('stock-movement-chart').innerHTML = '<div class="alert alert-info">No stock movement data available</div>';
        return;
    }

    // Group data by month for aggregated view
    const monthlyData = {};
    data.forEach(item => {
        const monthKey = `${item.Year}-${item.Month.toString().padStart(2, '0')}`;
        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = {
                monthYear: `${item.MonthName} ${item.Year}`,
                totalSales: 0,
                totalValue: 0,
                productCount: 0
            };
        }
        monthlyData[monthKey].totalSales += item.QuantitySold || 0;
        monthlyData[monthKey].totalValue += item.MonthlySalesValue || 0;
        monthlyData[monthKey].productCount += 1;
    });

    const chartData = Object.values(monthlyData).sort((a, b) => a.monthYear.localeCompare(b.monthYear));

    const trace1 = {
        x: chartData.map(d => d.monthYear),
        y: chartData.map(d => d.totalSales),
        type: 'bar',
        name: 'Units Sold',
        marker: { color: '#007bff' },
        yaxis: 'y'
    };

    const trace2 = {
        x: chartData.map(d => d.monthYear),
        y: chartData.map(d => d.totalValue),
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Sales Value (USD)',
        line: { color: '#28a745' },
        yaxis: 'y2'
    };

    const layout = {
        title: '',
        xaxis: { title: 'Month' },
        yaxis: { 
            title: 'Units Sold',
            side: 'left'
        },
        yaxis2: {
            title: 'Sales Value (USD)',
            side: 'right',
            overlaying: 'y',
            tickformat: '$,.0f'
        },
        margin: { t: 20, r: 60, b: 60, l: 60 },
        legend: { x: 0, y: 1 }
    };

    Plotly.newPlot('stock-movement-chart', [trace1, trace2], layout, {responsive: true});
}

function loadVelocityDistributionChart() {
    fetch('/inventory/api/stock-variation-kpis')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                createVelocityDistributionChart(data.data.velocity_distribution);
            }
        })
        .catch(error => console.error('Error loading velocity distribution:', error));
}

function createVelocityDistributionChart(velocityData) {
    const trace = {
        labels: ['High Velocity', 'Medium Velocity', 'Low Velocity', 'No Movement'],
        values: [
            velocityData.high_velocity,
            velocityData.medium_velocity,
            velocityData.low_velocity,
            velocityData.no_movement
        ],
        type: 'pie',
        marker: {
            colors: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
        },
        textinfo: 'label+percent+value',
        textposition: 'outside'
    };

    const layout = {
        title: '',
        margin: { t: 20, r: 20, b: 20, l: 20 },
        showlegend: false
    };

    Plotly.newPlot('velocity-distribution-chart', [trace], layout, {responsive: true});
}

function loadVelocitySummaryTable() {
    fetch('/inventory/api/stock-velocity-summary')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                populateVelocitySummaryTable(data.data);
                updateVelocitySummaryFooter(data.data);
            }
        })
        .catch(error => console.error('Error loading velocity summary:', error));
}

function populateVelocitySummaryTable(data) {
    const tbody = document.getElementById('velocity-summary-tbody');
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No velocity data available</td></tr>';
        return;
    }

    // Sort by annual sales value descending, limit to top 50
    const sortedData = data.sort((a, b) => b.AnnualSalesValue - a.AnnualSalesValue).slice(0, 50);

    let html = '';
    sortedData.forEach(item => {
        const statusClass = getStatusClass(item.StockHealthStatus);
        const trendIcon = getTrendIcon(item.TrendPercentage);
        
        html += `
            <tr class="velocity-row" data-status="${item.StockHealthStatus}">
                <td><strong>${item.ProductName}</strong></td>
                <td><span class="badge bg-secondary">${item.Category}</span></td>
                <td>${item.CurrentStock.toLocaleString()}</td>
                <td>${item.FormattedAnnualSalesValue}</td>
                <td>${item.FormattedTurnoverPercentage}</td>
                <td>${item.FormattedTrendPercentage} ${trendIcon}</td>
                <td>${item.FormattedMonthsOfStock}</td>
                <td><span class="badge bg-${statusClass}">${item.StockHealthStatus}</span></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    document.getElementById('velocity-summary-footer').style.display = 'table-footer-group';
}

function updateVelocitySummaryFooter(data) {
    const categories = new Set(data.map(item => item.Category)).size;
    const totalStock = data.reduce((sum, item) => sum + item.CurrentStock, 0);
    const totalSales = data.reduce((sum, item) => sum + item.AnnualSalesValue, 0);
    const avgTurnover = data.reduce((sum, item) => sum + item.AnnualTurnoverPercentage, 0) / data.length;
    const positiveTrends = data.filter(item => item.TrendPercentage > 5).length;
    const avgMonths = data.reduce((sum, item) => sum + (item.MonthsOfStock < 999 ? item.MonthsOfStock : 0), 0) / data.filter(item => item.MonthsOfStock < 999).length;
    const healthyCount = data.filter(item => item.StockHealthStatus === 'HEALTHY').length;

    document.getElementById('velocity-categories-count').textContent = categories;
    document.getElementById('velocity-total-stock').textContent = totalStock.toLocaleString();
    document.getElementById('velocity-total-sales').textContent = formatUSD(totalSales);
    document.getElementById('velocity-avg-turnover').textContent = `${avgTurnover.toFixed(1)}%`;
    document.getElementById('velocity-positive-trends').textContent = positiveTrends;
    document.getElementById('velocity-avg-months').textContent = avgMonths.toFixed(1);
    document.getElementById('velocity-healthy-count').textContent = healthyCount;
}

function setupVelocityTableFilters() {
    const filterButtons = document.querySelectorAll('[data-filter]');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filter table rows
            const filter = this.getAttribute('data-filter');
            const rows = document.querySelectorAll('.velocity-row');
            
            rows.forEach(row => {
                const status = row.getAttribute('data-status');
                if (filter === 'all') {
                    row.style.display = '';
                } else if (filter === 'high' && status === 'HEALTHY') {
                    row.style.display = '';
                } else if (filter === 'low' && (status === 'LOW_STOCK' || status === 'OVERSTOCK')) {
                    row.style.display = '';
                } else if (filter === 'dead' && status === 'DEAD_STOCK') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
}

function getStatusClass(status) {
    switch(status) {
        case 'HEALTHY': return 'success';
        case 'LOW_STOCK': return 'warning';
        case 'OVERSTOCK': return 'info';
        case 'DEAD_STOCK': return 'danger';
        case 'OUT_OF_STOCK': return 'dark';
        default: return 'secondary';
    }
}

function getTrendIcon(trendPercentage) {
    if (trendPercentage > 5) return '📈';
    if (trendPercentage < -5) return '📉';
    return '➡️';
}

// Stock Value Evolution Chart and Table
function loadStockValueData(months = 12) {
    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(months)) {
            btn.classList.add('active');
        }
    });
    
    fetch(`/inventory/api/stock-value-evolution?months=${months}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                createStockValueEvolutionChart(data.data);
                createStockValueBreakdownTable(data.data);
            }
        })
        .catch(error => console.error('Error loading stock value evolution:', error));
}

function createStockValueEvolutionChart(data) {
    if (!data || data.length === 0) {
        document.getElementById('stock-value-evolution-chart').innerHTML = '<div class="alert alert-info">No stock value data available</div>';
        return;
    }
    
    const dates = data.map(d => d.FormattedDate);
    const values = data.map(d => d.StockValue);
    
    const trace = {
        x: dates,
        y: values,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Stock Value',
        line: { 
            color: '#033663',
            width: 2.5
        },
        marker: {
            size: 5,
            color: '#033663'
        },
        fill: 'tozeroy',
        fillcolor: 'rgba(3, 54, 99, 0.1)'
    };
    
    const layout = {
        title: '',
        xaxis: { 
            title: 'Date',
            showgrid: true,
            gridcolor: '#e9ecef'
        },
        yaxis: { 
            title: 'Stock Value (USD)',
            tickformat: '$,.0f',
            showgrid: true,
            gridcolor: '#e9ecef'
        },
        margin: { t: 20, r: 40, b: 60, l: 80 },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        hovermode: 'x unified'
    };
    
    Plotly.newPlot('stock-value-evolution-chart', [trace], layout, {responsive: true});
    console.log('Stock value evolution chart created successfully');
}

function createStockValueBreakdownTable(data) {
    if (!data || data.length === 0) {
        document.getElementById('stock-value-breakdown-table').innerHTML = 
            '<tr><td colspan="3" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    // Group by month and get last value of each month
    const monthlyData = {};
    data.forEach(item => {
        const date = new Date(item.Date);
        const monthKey = `${item.Year}-${String(item.Month).padStart(2, '0')}`;
        const monthLabel = `${item.MonthName} ${item.Year}`;
        
        if (!monthlyData[monthKey] || new Date(monthlyData[monthKey].Date) < date) {
            monthlyData[monthKey] = {
                ...item,
                monthLabel: monthLabel,
                sortKey: monthKey
            };
        }
    });
    
    // Convert to array and sort by date (most recent first)
    const monthlyArray = Object.values(monthlyData).sort((a, b) => b.sortKey.localeCompare(a.sortKey));
    
    // Calculate month-over-month changes
    const tableRows = monthlyArray.map((item, index) => {
        const prevItem = monthlyArray[index + 1];
        let change = 0;
        let changeClass = '';
        let changeIcon = '';
        
        if (prevItem) {
            change = ((item.StockValue - prevItem.StockValue) / prevItem.StockValue) * 100;
            if (change > 0) {
                changeClass = 'text-success';
                changeIcon = '↗';
            } else if (change < 0) {
                changeClass = 'text-danger';
                changeIcon = '↘';
            } else {
                changeClass = 'text-muted';
                changeIcon = '→';
            }
        }
        
        return `
            <tr>
                <td><strong>${item.monthLabel}</strong></td>
                <td class="text-end">${item.FormattedValue}</td>
                <td class="text-end ${changeClass}">
                    ${prevItem ? `${changeIcon} ${Math.abs(change).toFixed(1)}%` : '-'}
                </td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('stock-value-breakdown-table').innerHTML = tableRows;
    console.log('Stock value breakdown table created successfully');
}
</script>
{% endblock %}