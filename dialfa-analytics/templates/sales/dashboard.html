{% extends "base.html" %}

{% block title %}Sales Analytics - Dialfa BI{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-graph-up-arrow"></i>
            Sales Analytics
        </h1>
        <p class="text-muted">Sales performance analysis, customer insights, and revenue forecasting</p>
    </div>
</div>

<!-- Key Sales Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card border-success">
            <div class="card-body text-center">
                <i class="bi bi-currency-dollar text-success mb-2" style="font-size: 2rem;"></i>
                <h3 id="total-revenue" class="text-success">Loading...</h3>
                <p class="card-text">Total Revenue (12M)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card border-primary">
            <div class="card-body text-center">
                <i class="bi bi-receipt text-primary mb-2" style="font-size: 2rem;"></i>
                <h3 id="total-transactions" class="text-primary">Loading...</h3>
                <p class="card-text">Total Transactions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card border-info">
            <div class="card-body text-center">
                <i class="bi bi-people text-info mb-2" style="font-size: 2rem;"></i>
                <h3 id="unique-customers" class="text-info">Loading...</h3>
                <p class="card-text">Active Customers</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card border-warning">
            <div class="card-body text-center">
                <i class="bi bi-calculator text-warning mb-2" style="font-size: 2rem;"></i>
                <h3 id="avg-invoice" class="text-warning">Loading...</h3>
                <p class="card-text">Avg Invoice Size</p>
            </div>
        </div>
    </div>
</div>

<!-- Sales Trends -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i>
                    Monthly Sales Trend (xERP)
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm active" onclick="changePeriod('month')">Monthly</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="changePeriod('quarter')">Quarterly</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="changePeriod('year')">Yearly</button>
                </div>
            </div>
            <div class="card-body">
                <div id="sales-trend-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer2"></i>
                    Sales Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Monthly Growth</span>
                        <span id="monthly-growth" class="fw-bold">Loading...</span>
                    </div>
                    <div class="progress">
                        <div id="growth-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>YTD Performance</span>
                        <span id="ytd-performance" class="fw-bold">Loading...</span>
                    </div>
                    <div class="progress">
                        <div id="ytd-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Customer Retention</span>
                        <span id="retention-rate" class="fw-bold">Loading...</span>
                    </div>
                    <div class="progress">
                        <div id="retention-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Analysis -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-trophy"></i>
                    Top Customers by Revenue (xERP)
                </h5>
            </div>
            <div class="card-body">
                <div id="top-customers-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart"></i>
                    Customer Segmentation
                </h5>
            </div>
            <div class="card-body">
                <div id="customer-segmentation-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- Sales Forecasting -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-crystal-ball"></i>
                    Sales Forecast (Next 6 Months)
                </h5>
            </div>
            <div class="card-body">
                <div id="forecast-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bullseye"></i>
                    Sales Targets
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Monthly Target</h6>
                    <div class="d-flex justify-content-between">
                        <span>ARS $50M</span>
                        <span id="monthly-target-pct" class="fw-bold">Loading...</span>
                    </div>
                    <div class="progress">
                        <div id="monthly-target-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Quarterly Target</h6>
                    <div class="d-flex justify-content-between">
                        <span>ARS $150M</span>
                        <span id="quarterly-target-pct" class="fw-bold">Loading...</span>
                    </div>
                    <div class="progress">
                        <div id="quarterly-target-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Annual Target</h6>
                    <div class="d-flex justify-content-between">
                        <span>ARS $600M</span>
                        <span id="annual-target-pct" class="fw-bold">Loading...</span>
                    </div>
                    <div class="progress">
                        <div id="annual-target-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-month"></i>
                    Monthly Performance Breakdown
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Month</th>
                                <th>Revenue</th>
                                <th>Transactions</th>
                                <th>Growth</th>
                                <th>Customers</th>
                            </tr>
                        </thead>
                        <tbody id="monthly-breakdown-tbody">
                            <tr>
                                <td colspan="5" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightbulb"></i>
                    Sales Insights & Recommendations
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle"></i> Positive Trends</h6>
                    <ul id="positive-insights" class="mb-0">
                        <li>Loading...</li>
                    </ul>
                </div>
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle"></i> Areas for Improvement</h6>
                    <ul id="improvement-insights" class="mb-0">
                        <li>Loading...</li>
                    </ul>
                </div>
                <div class="alert alert-info">
                    <h6><i class="bi bi-lightbulb"></i> Recommendations</h6>
                    <ul id="recommendation-insights" class="mb-0">
                        <li>Loading...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPeriod = 'month';

// Load sales data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadSalesData();
    loadSalesTrendChart();
    loadTopCustomersChart();
    loadCustomerSegmentation();
    loadSalesForecast();
    loadMonthlyBreakdown();
    loadSalesInsights();
    updateSalesTargets();
});

function loadSalesData() {
    fetch('/sales/api/summary')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const summary = data.data;
                document.getElementById('total-revenue').textContent = summary.formatted.total_revenue;
                document.getElementById('total-transactions').textContent = summary.total_transactions.toLocaleString();
                document.getElementById('unique-customers').textContent = summary.unique_customers;
                document.getElementById('avg-invoice').textContent = summary.formatted.avg_invoice_size;
            }
        })
        .catch(error => console.error('Error loading sales data:', error));
}

function loadSalesTrendChart() {
    fetch('/sales/api/monthly-trends')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                createSalesTrendChart(data.data);
                updatePerformanceMetrics(data.data);
            }
        })
        .catch(error => console.error('Error loading sales trends:', error));
}

function createSalesTrendChart(data) {
    if (!data || data.length === 0) {
        document.getElementById('sales-trend-chart').innerHTML = '<div class="alert alert-info">No sales trend data available</div>';
        return;
    }

    const trace = {
        x: data.map(d => d.MonthYearLabel),
        y: data.map(d => d.MonthlyRevenue),
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Monthly Revenue',
        line: { color: '#033663', width: 3 },
        marker: { size: 8, color: '#033663' }
    };

    const layout = {
        title: '',
        xaxis: { title: 'Month', showgrid: true, gridcolor: '#e9ecef' },
        yaxis: { title: 'Revenue (ARS)', tickformat: '$,.0f', showgrid: true, gridcolor: '#e9ecef' },
        margin: { t: 20, r: 40, b: 60, l: 80 },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)'
    };

    Plotly.newPlot('sales-trend-chart', [trace], layout, {responsive: true});
}

function updatePerformanceMetrics(data) {
    if (data.length >= 2) {
        const latestGrowth = data[0].MonthOverMonthGrowth || 0;
        document.getElementById('monthly-growth').textContent = latestGrowth.toFixed(1) + '%';
        
        const progressClass = latestGrowth >= 0 ? 'bg-success' : 'bg-danger';
        const progressBar = document.getElementById('growth-progress');
        progressBar.className = `progress-bar ${progressClass}`;
        progressBar.style.width = Math.min(Math.abs(latestGrowth), 100) + '%';
    }
    
    // Mock YTD and retention data
    document.getElementById('ytd-performance').textContent = '+23.4%';
    document.getElementById('ytd-progress').style.width = '78%';
    document.getElementById('retention-rate').textContent = '84.2%';
    document.getElementById('retention-progress').style.width = '84%';
}

function loadTopCustomersChart() {
    fetch('/sales/api/xerp-top-customers')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                createTopCustomersChart(data.data);
            }
        })
        .catch(error => console.error('Error loading top customers:', error));
}

function createTopCustomersChart(data) {
    if (!data || data.length === 0) {
        document.getElementById('top-customers-chart').innerHTML = '<div class="alert alert-info">No customer data available</div>';
        return;
    }

    const trace = {
        x: data.map(c => c.TotalRevenue),
        y: data.map(c => c.CustomerName),
        type: 'bar',
        orientation: 'h',
        marker: { color: '#28a745' }
    };

    const layout = {
        title: '',
        xaxis: { title: 'Total Revenue (ARS)', tickformat: '$,.0f' },
        yaxis: { title: '' },
        margin: { t: 20, r: 40, b: 60, l: 120 }
    };

    Plotly.newPlot('top-customers-chart', [trace], layout, {responsive: true});
}

function loadCustomerSegmentation() {
    // Mock customer segmentation data
    const segmentData = [
        { segment: 'Enterprise', count: 15, revenue: 280000000 },
        { segment: 'Mid-Market', count: 28, revenue: 120000000 },
        { segment: 'Small Business', count: 28, revenue: 40000000 }
    ];

    const trace = {
        labels: segmentData.map(s => s.segment),
        values: segmentData.map(s => s.revenue),
        type: 'pie',
        textinfo: 'label+percent',
        marker: {
            colors: ['#033663', '#28a745', '#ffc107']
        }
    };

    const layout = {
        margin: { t: 20, r: 20, b: 20, l: 20 },
        showlegend: true,
        legend: { orientation: 'h', y: -0.1 }
    };

    Plotly.newPlot('customer-segmentation-chart', [trace], layout, {responsive: true});
}

function loadSalesForecast() {
    // Mock forecast data based on historical trends
    const forecastData = [
        { month: 'Oct 2025', actual: null, forecast: 45000000 },
        { month: 'Nov 2025', actual: null, forecast: 48000000 },
        { month: 'Dec 2025', actual: null, forecast: 52000000 },
        { month: 'Jan 2026', actual: null, forecast: 44000000 },
        { month: 'Feb 2026', actual: null, forecast: 46000000 },
        { month: 'Mar 2026', actual: null, forecast: 49000000 }
    ];

    const trace = {
        x: forecastData.map(d => d.month),
        y: forecastData.map(d => d.forecast),
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Forecast',
        line: { color: '#ffc107', width: 3, dash: 'dash' },
        marker: { size: 8, color: '#ffc107' }
    };

    const layout = {
        title: '',
        xaxis: { title: 'Month', showgrid: true, gridcolor: '#e9ecef' },
        yaxis: { title: 'Forecasted Revenue (ARS)', tickformat: '$,.0f', showgrid: true, gridcolor: '#e9ecef' },
        margin: { t: 20, r: 40, b: 60, l: 80 },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)'
    };

    Plotly.newPlot('forecast-chart', [trace], layout, {responsive: true});
}

function loadMonthlyBreakdown() {
    fetch('/sales/api/monthly-trends')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                populateMonthlyBreakdown(data.data);
            }
        })
        .catch(error => console.error('Error loading monthly breakdown:', error));
}

function populateMonthlyBreakdown(data) {
    const tbody = document.getElementById('monthly-breakdown-tbody');
    tbody.innerHTML = '';

    data.forEach(month => {
        const row = document.createElement('tr');
        const growthClass = month.MonthOverMonthGrowth >= 0 ? 'text-success' : 'text-danger';
        const growthIcon = month.MonthOverMonthGrowth >= 0 ? '↗' : '↘';
        
        row.innerHTML = `
            <td><strong>${month.MonthYearLabel}</strong></td>
            <td>${formatCurrency(month.MonthlyRevenue)}</td>
            <td>${month.TransactionCount}</td>
            <td class="${growthClass}">${growthIcon} ${month.MonthOverMonthGrowth.toFixed(1)}%</td>
            <td>${month.UniqueCustomers}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateSalesTargets() {
    // Mock target calculations
    const currentMonthRevenue = 41800000; // From latest data
    const monthlyTarget = 50000000;
    const monthlyPct = (currentMonthRevenue / monthlyTarget) * 100;
    
    document.getElementById('monthly-target-pct').textContent = monthlyPct.toFixed(1) + '%';
    document.getElementById('monthly-target-progress').style.width = Math.min(monthlyPct, 100) + '%';
    document.getElementById('monthly-target-progress').className = `progress-bar ${monthlyPct >= 100 ? 'bg-success' : monthlyPct >= 80 ? 'bg-warning' : 'bg-danger'}`;
    
    // Quarterly (mock)
    document.getElementById('quarterly-target-pct').textContent = '89.3%';
    document.getElementById('quarterly-target-progress').style.width = '89%';
    
    // Annual (mock)
    document.getElementById('annual-target-pct').textContent = '73.5%';
    document.getElementById('annual-target-progress').style.width = '74%';
}

function loadSalesInsights() {
    const positiveInsights = [
        'Strong Q3 performance with 28% growth in September',
        'Customer retention rate improved to 84.2%',
        'Average invoice size increased by 15% YoY',
        'Top 10 customers contribute 65% of total revenue'
    ];
    
    const improvementInsights = [
        'August showed -38% decline - investigate seasonal factors',
        'Customer acquisition rate down 12% from last quarter',
        'Payment collection period increased to 45 days'
    ];
    
    const recommendations = [
        'Focus on customer retention programs for mid-tier clients',
        'Implement seasonal inventory planning for Q4',
        'Develop upselling strategies for existing customers',
        'Review pricing strategy for competitive positioning'
    ];
    
    document.getElementById('positive-insights').innerHTML = positiveInsights.map(insight => `<li>${insight}</li>`).join('');
    document.getElementById('improvement-insights').innerHTML = improvementInsights.map(insight => `<li>${insight}</li>`).join('');
    document.getElementById('recommendation-insights').innerHTML = recommendations.map(insight => `<li>${insight}</li>`).join('');
}

function changePeriod(period) {
    currentPeriod = period;
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Load data for the selected period
    fetch(`/sales/api/performance-by-period?period=${period}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                createPeriodChart(data.data, period);
            }
        })
        .catch(error => console.error('Error loading period data:', error));
}

function createPeriodChart(data, period) {
    if (!data || data.length === 0) {
        document.getElementById('sales-trend-chart').innerHTML = '<div class="alert alert-info">No data available for this period</div>';
        return;
    }

    const trace = {
        x: data.map(d => d.PeriodLabel),
        y: data.map(d => d.Revenue),
        type: 'scatter',
        mode: 'lines+markers',
        name: `${period.charAt(0).toUpperCase() + period.slice(1)}ly Revenue`,
        line: { color: '#033663', width: 3 },
        marker: { size: 8, color: '#033663' }
    };

    const layout = {
        title: '',
        xaxis: { title: period.charAt(0).toUpperCase() + period.slice(1), showgrid: true, gridcolor: '#e9ecef' },
        yaxis: { title: 'Revenue (ARS)', tickformat: '$,.0f', showgrid: true, gridcolor: '#e9ecef' },
        margin: { t: 20, r: 40, b: 60, l: 80 },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)'
    };

    Plotly.newPlot('sales-trend-chart', [trace], layout, {responsive: true});
}
</script>
{% endblock %}